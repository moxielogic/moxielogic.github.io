<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="./theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="./theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Anthony Green">
  <meta name="description" content="Posts and writings by Anthony Green">

  <link href="http://moxielogic.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Moxie Blog Atom" />
  <link href="http://moxielogic.github.io/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="The Moxie Blog RSS" />

<meta name="keywords" content="architecture">

  <title>
    The Moxie Blog
&ndash; Processor Exceptions  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-72427332-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href=".">
        <img src="http://moxielogic.github.io/images/ml.png" alt="logo">
      </a>
      <h2><a href=".">The Moxie Blog</a></h2>
      <p>A development blog for the <b>moxie processor</b>, an open source embedded soft-core processor.</p>
      <ul>
        <li><a href="./pages/about.html">About</a></li>
        <li><a href="./pages/author.html">Author</a></li>
        <li><a href="http://moxielogic.org/blog/pages/architecture.html" target="_blank">Architecture</a></li>
        <li><a href="http://moxielogic.org/blog/pages/toolchain.html" target="_blank">Toolchain</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href=".">Index</a> &brvbar; <a href="./archives.html">Archives</a>
      &brvbar; <a href="http://moxielogic.github.io/blog/feeds/all.atom.xml">Atom</a>
      &brvbar; <a href="http://moxielogic.github.io/blog/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h3><a href="./processor-exceptions.html">Processor Exceptions</a></h3>
  </div>
  <div class="article_text">
    <p>My first go at exceptions is working well. The basic idea is that moxie
will have a single exception handling routine whose address lives in
special register 1. You set the exception handler like so:</p>
<div class="highlight"><pre>void install_handler(void (*handler)(void))
{
  printf (&quot;Installing handler 0x%x\n&quot;, (unsigned) handler);
  asm(&quot;ssr %0, 1&quot; : : &quot;r&quot; (handler));
}
</pre></div>


<p>When the processor hits an exception, it performs a standard function
call to the handler. We return from the handler just like it was any old
function, since it currently uses the standard C ABI. The exception type
will be found in special register 2. The current exception types are as
follows:</p>
<div class="highlight"><pre>#define MOXIE_EX_DIV0 0 /* Divide by zero */
#define MOXIE_EX_BAD  1 /* Illegal instruction */
#define MOXIE_EX_IRQ  2 /* Interrupt request */
#define MOXIE_EX_SWI  3 /* Software interrupt */
</pre></div>


<p>In the case of IRQ and SWI exceptions, the interrupt number will be
found in special register 3. I don't have instructions yet to disable or
enable interrupts, but those are an obvious next step. Here's a sample
exception handler:</p>
<div class="highlight"><pre>void handler (void)
{
  int et;

  /* Get the exception handler from special register 2.  */
  asm(&quot;gsr %0, 2&quot; : &quot;=r&quot;(et) : &quot;0&quot;(et) );

  switch (et)
    {
    case MOXIE_EX_DIV0:
      printf(&quot;DIVIDE BY ZERO EXCEPTION\n&quot;);
      break;
    case MOXIE_EX_BAD:
      printf(&quot;ILLEGAL INSTRUCTION EXCEPTION\n&quot;);
      break;
    case MOXIE_EX_IRQ:
      {
        int irq;
        asm(&quot;gsr %0, 3&quot; : &quot;=r&quot;(irq) : &quot;0&quot;(irq) );
        printf(&quot;INTERRUPT REQUEST %d\n&quot;, irq);
      }
      break;
    case MOXIE_EX_SWI:
      {
        int swi;
        asm(&quot;gsr %0, 3&quot; : &quot;=r&quot;(swi) : &quot;0&quot;(swi) );
        printf(&quot;SOFTWARE INTERRUPT REQUEST %d\n&quot;, swi);
      }
      break;
    default:
      printf(&quot;UNKNOWN EXCEPTION 0x%x\n&quot;, et);
      break;
    }
}
</pre></div>


<p>The handler for DIV0 and SWI may also want to know where the exception
happened. This can be determined by pulling the return address off of
the stack and subtracting the appropriate instruction length (2 for div
and 6 for swi).</p>
<p>I've implemented support for this in the qemu port, and the test
directory in moxiedev contains a simple program to exercise this new
functionality. I think we'll want to hook up some peripherals in qemu to
the IRQ system soon.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Thu 02 April 2009</p>
    <p>Category: <a href="./category/moxie.html">moxie</a>
 &ndash; Tags:
      <a href="./tag/architecture.html">architecture</a>    </p>
  </div>

  <div id="article_comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "processor-exceptions.html";
        (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'http://moxieblog.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
    </script>
  </div>

</article>


    <div id="ending_message">
      <p>&copy; Anthony Green. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>